name: RDP Connection
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
    - name: Install Desktop Environment
      run: |
        sudo apt-get update
        sudo apt install -y ubuntu-desktop xrdp
        sudo systemctl enable xrdp
        sudo systemctl start xrdp
        
    - name: Setup RDP Password
      run: |
        # Set password for existing runner user
        echo "runner:${{ secrets.RDP_PASSWORD }}" | sudo chpasswd
        
    - name: Start Cloudflare Tunnel
      env:
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        sudo cloudflared service install ${CLOUDFLARE_TOKEN}
        sudo systemctl start cloudflared
        
    - name: Keep Alive
      run: sleep 6h
